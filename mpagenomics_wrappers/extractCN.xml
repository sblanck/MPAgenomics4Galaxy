<tool id="extract" name="Extract" version="1.2.0">
  <description>copy number or allele B fraction signal</description>
   <requirements>
        <container type="docker">sblanck/mpagenomicsdependencies</container>
  </requirements>
  <command>
    	<![CDATA[ 
        Rscript 
        ${__tool_directory__}/extractCN.R	
    --chrom '$chrom'
  	--input '$input'
  	--zip '$zip'
  	--output '$output' 
  	--new_file_path '$output.extra_files_path'
  	#if $settings.settingsType == "file":
  		--settings_type '$settings.inputs'
  	#end if
  	#if $settings.settingsType == "dataset":
  		--settings_type 'dataset'
  	#end if
  	#if $settingsSNP.signal == "fracB":
  		--settings_snp 'TRUE'
  		
  		#if $settingsSNP.sym.symmetrize=="TRUE"
  			--settings_tumor '$settingsSNP.sym.tumorcsvFracBsym'
  		#elif $settingsSNP.sym.symmetrize=="FALSE"
  			#if $settingsSNP.sym.settingsTumorFracB.settingsTypeTumorFracB == "standard":
  				--settings_tumor 'None'
  			#elif  $settingsSNP.sym.settingsTumorFracB.settingsTypeTumorFracB == "tumor":
			--settings_tumor '${settingsSNP.sym.settingsTumorFracB.tumorcsvFracB}'
   			#end if
  		#end if
  		--symmetrize '$settingsSNP.sym.symmetrize'
  	#else
  		--settings_snp '$settingsSNP.snp'
  		#if $settingsSNP.settingsTumor.settingsTypeTumor == "standard":
  			--settings_tumor 'None'
  		#elif $settingsSNP.settingsTumor.settingsTypeTumor == "tumor":
		--settings_tumor '${settingsSNP.settingsTumor.tumorcsvCN}'
  		#end if
  	#end if
  	--outputlog '$outputlog'
  	--log '$log' 
  	--settings_signal '$settingsSNP.signal'
  	--userid '$__user_id__'
        	]]>
  </command>
  <inputs>
    <param name="input" type="data" format="dsf" label="Dataset summary file" help="Summary text file generated by the Data normalization tool"/>
	  <param name="zip" type="data" format="zip" label="Zip results file" help="Zip results file generated by the Data normalization tool"/>
	<conditional name="settings">
      <param name="settingsType" type="select" label="Files selection Mode" help="Select the whole cel files dataset or pick-up only few files from the dataset">
        <option value="dataset">Select whole dataset</option>
        <option value="file">Select file individually</option>
      </param>
      <when value="dataset"/>
      <when value="file">
        <param name="inputs" type="select" format="cel" multiple="true" label="Cel files">
        <options from_dataset="input">
    		<column name="name" index="0"/>
    		<column name="value" index="0"/>
		</options>
		</param>
	   </when>
    </conditional>
    
    <conditional name="settingsSNP">
    	<param name="signal" type="select" multiple="false" label="Signal you want to work on">
     		<option value="CN">CN</option>
      		<option value="fracB">fracB</option>
    	</param> 
    	<when value="fracB">
    		<conditional name="sym">
    			<param name="symmetrize" type="select" label="Symmetrize allele B signal">
        			<option value="TRUE">Yes</option>
        			<option value="FALSE">No</option>
    			</param>
    			<when value="TRUE">
    				<param name="tumorcsvFracBsym" type="data" format="csv" label="Normal-tumor csv file" help="Normal-tumor csv file. See below for more information."/>
    			</when>
    			<when value="FALSE">
    				<conditional name="settingsTumorFracB">
      					<param name="settingsTypeTumorFracB" type="select" label="Reference">
        					<option value="standard">Study without reference</option>
        					<option value="tumor">Normal-tumor study</option>
      					</param>
      					<when value="standard"/>
      					<when value="tumor">
        					<param name="tumorcsvFracB" type="data" format="csv" label="Tumor boost csv file" help="Normal-tumor csv file. See below for more information."/>
      					</when>
    				</conditional>        	
    			</when>
    		</conditional>
    	</when>
		<when value="CN">
			<conditional name="settingsTumor">
      			<param name="settingsTypeTumor" type="select" label="Reference">
        			<option value="standard">Study without reference</option>
        			<option value="tumor">Normal-tumor study</option>
      			</param>
      			<when value="standard"/>
      			<when value="tumor">
        			<param name="tumorcsvCN" type="data" format="csv" label="Normal tumor csv file" help="Normal-tumor csv file. See below for more information."/>
      			</when>
    		</conditional>        	
     		<param name="snp" type="select" label="Select Probes">
        		<option value="FALSE">CN and SNP probes</option>
        		<option value="TRUE">Only SNP probes</option>
    		</param>
    	</when>
    </conditional>
         
    <!--param name="chrom" type="text" value="All" label="Chromosomes" help="Chromosomes to segment. Use comma to choose multiple chromosomes: e.g. 1, 3, 8. Use 'All' for a segmentation on all chromosomes" /-->
    
    <param  name="chrom" type="select" size="6" multiple="true" label="Chromosomes" help="You can select several chromosomeleave blank for all chromosomes">
      <option value="1">chr 1</option>
      <option value="2">chr 2</option>
      <option value="3">chr 3</option>
      <option value="4">chr 4</option>
      <option value="5">chr 5</option>
      <option value="6">chr 6</option>
      <option value="7">chr 7</option>
      <option value="8">chr 8</option>
      <option value="9">chr 9</option>
      <option value="10">chr 10</option>
      <option value="11">chr 11</option>
      <option value="12">chr 12</option>
      <option value="13">chr 13</option>
      <option value="14">chr 14</option>
      <option value="15">chr 15</option>
      <option value="16">chr 16</option>
      <option value="17">chr 17</option>
      <option value="18">chr 18</option>
      <option value="19">chr 19</option>
      <option value="20">chr 20</option>
      <option value="21">chr 21</option>
      <option value="22">chr 22</option>
      <option value="23">chr 23</option>
      <option value="24">chr 24</option>
      <option value="25">chr 25</option>
      
    </param>   	
     
    <param name="outputlog" type="select" label="Output log">
        <option value="TRUE">Yes</option>
        <option value="FALSE">No</option>
    </param>
  </inputs>
  <outputs>
    <data format="sef" name="output" label="signal extraction of ${input.name}" />
    <data format="log" name="log" label="log of signal extraction of ${input.name}">
    	<filter>outputlog == "TRUE"</filter>
    </data>
   </outputs>
   <stdio>
    <exit_code range="1:"   level="fatal"   description="See logs for more details" />
   </stdio>
<help>
.. class:: warningmark

Data normalization must be run (with the data normalization tool) prior to signal extraction.

-----

**What it does**     	
This tool extracts the copy number profile from the normalized data. 
	
Outputs:
  	
*A tabular text file containing 3 fixed columns and 1 column per sample:*
	
	- chr: Chromosome.
	- position: Genomic position (in bp).
	- probeNames: Name of the probes of the microarray.
	- One column per sample which contains the copy number profile for each sample.
  		
-----
  		
**Normal-tumor study**
     	
In cases where normal (control) samples match to tumor samples, normalization can be improved using TumorBoost. In this case, a normal-tumor csv file must be provided :

	- The first column contains the names of the files corresponding to normal samples of the dataset.
     	 
	- The second column contains the names of the tumor samples files. 
     	
	- Column names of these two columns are respectively normal and tumor.
     	
	- Columns are separated by a comma.
     	
	- *Extensions of the files (.CEL for example) should be removed*


     	
**Example** 

Let 6 .cel files in the studied dataset (3 patients, each of them being represented by a couple of normal and tumor cel files.) ::
     	
     	patient1_normal.cel
     	patient1_tumor.cel
     	patient2_normal.cel
     	patient2_tumor.cel
     	patient3_normal.cel 
     	patient3_tumor.cel
      	

The csv file should look like this ::
     	
     	normal,tumor
     	patient1_normal,patient1_tumor
     	patient2_normal,patient2_tumor
     	patient3_normal,patient3_tumor

-----     	  		

     	
**Citation**
	
If you use this tool please cite : 

`Q. Grimonprez, A. Celisse, M. Cheok, M. Figeac, and G. Marot. Mpagenomics : An r package for multi-patients analysis of genomic markers, 2014. Preprint &lt;http://fr.arxiv.org/abs/1401.5035&gt;`_
  

</help>
</tool>
